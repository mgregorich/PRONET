---
title: 'PRONET - Simulation study'
author: "Mariella Gregorich"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::html_document2:
    css: "css_style.css"
    theme: cosmo
    number_sections: true
    keep_md: no
    fig_caption: true
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: 
      collapsed: true
      smooth_scroll: true
    highlight: tango
---


```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = F, warning=F, message=F)

source(here::here("src","functions_main.R"))
source(here::here("src","functions_aux.R"))
source(here::here("src","setup.R"))

# Paths
out.path <- "output"
sim.file <- "sim_onethresh_2804/"              #paste0("sim_", Sys.Date(),"/")
sim.path <- here::here(out.path, sim.file)

# Read in results
tbl_scens <- readRDS(here::here(sim.path, "tbl_scenarios_results.rds"))

# Conditional chunk execution
eval_dgthresh <- length(unique(tbl_scens$dg.thresh))>1
```


```{r}
# Preprocess
tbl_scens <- tbl_scens %>%
  mutate_at(vars(dg.thresh), as.factor) %>%
  mutate(beta.params=fct_relevel(beta.params, c("c(2, 4)","c(4, 4)","c(4, 2)")))
```

# Simulation setup info

The following parameter were included to create the semi-factorial simulation setup:
```{r echo=FALSE}
tmp <- read.table(here::here(sim.path, list.files(sim.path, pattern = "info_")[1]))
tmp <- str_split_fixed(tmp[19:36,], pattern = "#", n=2)
  
tmp %>% 
  data.frame() %>%
  `colnames<-`(c("Code", "Explanation")) %>%
  kbl(caption="Parameters for the semi-factorial simulation setup", escape = F) %>%
  kable_classic(full_width = T, html_font = "Calibri")%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left",fixed_thead = T)
```



# Graphical assessment of results

## One dg threshold
```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=10, fig.height=8, fig.cap="Nested line plot for RMSE for ThreshMethod = trim and eps.g = 0.1"}
tbl_scens %>%
  filter(ThreshMethod %in% "trim" & eps.g == 0.1 ) %>%
  mutate_at(vars(beta.params, SparsMethod, AnaMethod), as.factor) %>%
  mutate(dg.thresh = paste0("DG threshold = ", dg.thresh)) %>%
  ggplot(aes(x=eps.y, y=RMSE.est, group=AnaMethod, col=AnaMethod)) +
  geom_ribbon(aes(x=eps.y, ymax=RMSE.up, ymin=RMSE.lo, fill=AnaMethod), linetype=2,alpha=.05) +
  geom_line() +
  geom_point() +
  scale_x_discrete("Random error Y") +
  scale_y_continuous("RMSE") +
  facet_nested(dg.thresh~beta.params + SparsMethod) +
  theme_bw() +
  theme(text = element_text(size=12))
ggsave(file = paste0(sim.path, "/fig_rmse_epsy_nested_beta_sparsmethods_dgthresh_filter_trim_epsG0.1.tiff"),  
              width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw") 
```

<br>

```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=10, fig.height=8, fig.cap="Nested line plot for RMSE for dg.thresh = 0.4 and eps.g = 0.1"}
tbl_scens %>%
  filter(dg.thresh %in% 0.4 & eps.g == 0.1 ) %>%
  mutate_at(vars(beta.params, SparsMethod, AnaMethod), as.factor) %>%
  ggplot(aes(x=eps.y, y=RMSE.est, group=AnaMethod, col=AnaMethod)) +
  geom_ribbon(aes(x=eps.y, ymax=RMSE.up, ymin=RMSE.lo, fill=AnaMethod), linetype=2,alpha=.05) +
  geom_line() +
  geom_point() +
  scale_x_discrete("Random error Y") +
  scale_y_continuous("RMSE") +
  facet_nested(beta.params ~ SparsMethod + ThreshMethod) +
  theme_bw() +
  theme(text = element_text(size=12))
ggsave(file = paste0(sim.path, "/fig_rmse_epsy_nested_beta_sparsmethods_dgthresh_filter_trim_epsG0.1.tiff"),  
              width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw") 
```

<br> 

```{r, echo=F, warning=F, message=F, eval=eval_dgthresh, fig.align='center', fig.width=10, fig.height=8, fig.cap="Nested line plot for RMSE for ThreshMethod = trim and eps.y = 1"}
tbl_scens %>%
  filter(ThreshMethod %in% "trim" & eps.y == 1) %>%
  mutate_at(vars(beta.params, SparsMethod, AnaMethod), as.factor) %>%
  mutate(dg.thresh = paste0("DG threshold = ", dg.thresh)) %>%
  ggplot(aes(x=eps.g, y=RMSE.est, group=AnaMethod, col=AnaMethod)) +
  geom_ribbon(aes(x=eps.g, ymax=RMSE.up, ymin=RMSE.lo, fill=AnaMethod), linetype=2,alpha=.05) +
  geom_line() +
  geom_point() +
  scale_x_discrete("Epsilon G") +
  scale_y_continuous("RMSE") +
  facet_nested(dg.thresh~beta.params + SparsMethod) +
  theme_bw() +
  theme(text = element_text(size=12))
ggsave(file = paste0(sim.path, "/fig_rmse_epsg_nested_beta_sparsmethods_dgthresh_filter_trim_epsY1.tiff"),  
              width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw") 
```

<br>

```{r, fig.align='center', fig.width=10, fig.height=8, fig.cap="Nested line plot for RMSE for ThreshMethod != bin, DG threshold = 0.4 and beta params = c(4,2)"}
tbl_scens %>%
  filter(dg.thresh==0.4 & beta.params %in% "c(4, 2)" & !c(ThreshMethod %in% "bin")) %>%
  mutate_at(vars(beta.params, SparsMethod, AnaMethod), as.factor) %>%
  mutate(eps.g = paste0("eps G = ", eps.g)) %>%
  ggplot(aes(x=eps.y, y=RMSE.est, group=AnaMethod, col=AnaMethod)) +
  geom_ribbon(aes(x=eps.y, ymax=RMSE.up, ymin=RMSE.lo, fill=AnaMethod), linetype=2,alpha=.05) +
  geom_line() +
  geom_point() +
  scale_x_discrete("Epsilon Y") +
  scale_y_continuous("RMSE") +
  facet_nested(eps.g~SparsMethod + ThreshMethod) +
  theme_bw() +
  theme(text = element_text(size=12))
ggsave(file = paste0(sim.path, "/fig_rmse_epsy_nested_epsg_sparsmethods_dgthresh_filter_beta42_dgthresh0.4_bin.tiff"),  
              width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw") 
```

<br>

```{r, fig.align='center', fig.width=10, fig.height=8, fig.cap="Nested line plot for RMSE for ThreshMethod = trim and beta params = c(4,2)"}
tbl_scens %>%
  filter(dg.thresh==0.4 & beta.params %in% "c(4, 2)") %>%
  mutate_at(vars(beta.params, SparsMethod, AnaMethod), as.factor) %>%
  mutate(eps.g = paste0("eps G = ", eps.g)) %>%
  ggplot(aes(x=eps.y, y=RMSE.est, group=AnaMethod, col=AnaMethod)) +
  geom_ribbon(aes(x=eps.y, ymax=RMSE.up, ymin=RMSE.lo, fill=AnaMethod), linetype=2,alpha=.05) +
  geom_line() +
  geom_point() +
  scale_x_discrete("Epsilon Y") +
  scale_y_continuous("RMSE") +
  facet_nested(eps.g~SparsMethod + ThreshMethod) +
  theme_bw() +
  theme(text = element_text(size=12))
ggsave(file = paste0(sim.path, "/fig_rmse_epsy_nested_epsg_sparsmethods_dgthresh_filter_beta42_dgthresh0.4.tiff"),  
              width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw") 
```


<!-- ## Randomly selected dg threshold from sequence -->

<!-- ### Random error G -->
<!-- ```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=10, fig.height=6, fig.cap="Nested line plot for RMSE for ThreshMethod = trim and eps.y = 1.5"} -->
<!-- tbl_scens %>% -->
<!--   filter(ThreshMethod %in% "trim" & eps.y == 1.5) %>% -->
<!--   mutate_at(vars(beta.params, SparsMethod, AnaMethod), as.factor) %>% -->
<!--   mutate(beta.params = paste0("beta pars = ", beta.params)) %>% -->
<!--   ggplot(aes(x=eps.g, y=RMSE.est, group=AnaMethod, col=AnaMethod)) + -->
<!--   geom_ribbon(aes(x=eps.g, ymax=RMSE.up, ymin=RMSE.lo, fill=AnaMethod), linetype=2,alpha=.05) + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   scale_x_discrete("Random error G") + -->
<!--   scale_y_continuous("RMSE") + -->
<!--   facet_nested(SparsMethod ~ beta.params) + -->
<!--   theme_bw() + -->
<!--   theme(text = element_text(size=12)) -->
<!-- ggsave(file = paste0(sim.path, "/fig_rmse_epsg_nested_beta_sparsmethods_filter_epsY1.5.tiff"),  -->
<!--        width=1.5*200, height=1*200, units="mm", dpi=350, compression = "lzw") -->
<!-- ``` -->


<!-- ```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=10, fig.height=6, fig.cap="Nested line plot for RMSE for ThreshMethod = trim and eps.y = 0.5"} -->
<!-- tbl_scens %>% -->
<!--   filter(ThreshMethod %in% "trim" & eps.y == 0.5) %>% -->
<!--   mutate_at(vars(beta.params, SparsMethod, AnaMethod), as.factor) %>% -->
<!--   mutate(beta.params = paste0("beta pars = ", beta.params)) %>% -->
<!--   ggplot(aes(x=eps.g, y=RMSE.est, group=AnaMethod, col=AnaMethod)) + -->
<!--   geom_ribbon(aes(x=eps.g, ymax=RMSE.up, ymin=RMSE.lo, fill=AnaMethod), linetype=2,alpha=.05) + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   scale_x_discrete("Random error G") + -->
<!--   scale_y_continuous("RMSE") + -->
<!--   facet_nested(SparsMethod ~ beta.params) + -->
<!--   theme_bw() + -->
<!--   theme(text = element_text(size=12)) -->
<!-- ggsave(file = paste0(sim.path, "/fig_rmse_epsg_nested_beta_sparsmethods_filter_epsY0.5.tiff"),  -->
<!--        width=1.5*200, height=1*200, units="mm", dpi=350, compression = "lzw") -->
<!-- ``` -->

<!-- ```{r, echo=F, warning=F, message=F,  fig.align='center', fig.width=10, fig.height=6, fig.cap="Nested line plot for RMSE for all ThreshMethods and eps.y = 1.5"} -->
<!-- tbl_scens %>% -->
<!--   filter(eps.y == 1.5) %>% -->
<!--   mutate_at(vars(beta.params, SparsMethod, AnaMethod), as.factor) %>% -->
<!--   mutate(beta.params = paste0("beta pars = ", beta.params)) %>% -->
<!--   ggplot(aes(x=eps.g, y=RMSE.est, group=AnaMethod, col=AnaMethod)) + -->
<!-- #  geom_ribbon(aes(x=eps.g, ymax=RMSE.up, ymin=RMSE.lo, fill=AnaMethod), linetype=2,alpha=.05) + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   scale_x_discrete("Random error G") + -->
<!--   scale_y_continuous("RMSE") + -->
<!--   facet_nested( ThreshMethod~ beta.params + SparsMethod) + -->
<!--   theme_bw() + -->
<!--   theme(text = element_text(size=12)) -->
<!-- ggsave(file = paste0(sim.path, "/fig_rmse_epsg_nested_beta_sparsmethods_threshmethods_filter_epsY1.5.tiff"),  -->
<!--        width=1.5*200, height=1*200, units="mm", dpi=350, compression = "lzw") -->
<!-- ``` -->


<!-- ### Random error Y -->

<!-- ```{r, echo=F, warning=F, message=F,  fig.align='center', fig.width=10, fig.height=6, fig.cap="Nested line plot for RMSE for ThreshMethod = trim and eps.g = 0.05"} -->
<!-- tbl_scens %>% -->
<!--   filter(ThreshMethod %in% "trim" & eps.g == 0.05) %>% -->
<!--   mutate_at(vars(beta.params, SparsMethod, AnaMethod), as.factor) %>% -->
<!--   mutate(beta.params = paste0("beta pars = ", beta.params)) %>% -->
<!--   ggplot(aes(x=eps.y, y=RMSE.est, group=AnaMethod, col=AnaMethod)) + -->
<!--   geom_ribbon(aes(x=eps.y, ymax=RMSE.up, ymin=RMSE.lo, fill=AnaMethod), linetype=2,alpha=.05) + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   scale_x_discrete("Random error Y") + -->
<!--   scale_y_continuous("RMSE") + -->
<!--   facet_nested(SparsMethod ~ beta.params) + -->
<!--   theme_bw() + -->
<!--   theme(text = element_text(size=12)) -->
<!-- ggsave(file = paste0(sim.path, "/fig_rmse_epsg_nested_beta_sparsmethods_filter_epsG0.05.tiff"),  -->
<!--        width=1.5*200, height=1*200, units="mm", dpi=350, compression = "lzw") -->
<!-- ``` -->


<!-- ```{r, echo=F, warning=F, message=F,  fig.align='center', fig.width=10, fig.height=6, fig.cap="Nested line plot for RMSE for ThreshMethod = trim and eps.g = 0.2"} -->
<!-- tbl_scens %>% -->
<!--   filter(ThreshMethod %in% "trim" & eps.g == 0.2) %>% -->
<!--   mutate_at(vars(beta.params, SparsMethod, AnaMethod), as.factor) %>% -->
<!--   mutate(beta.params = paste0("beta pars = ", beta.params)) %>% -->
<!--   ggplot(aes(x=eps.y, y=RMSE.est, group=AnaMethod, col=AnaMethod)) + -->
<!--   geom_ribbon(aes(x=eps.y, ymax=RMSE.up, ymin=RMSE.lo, fill=AnaMethod), linetype=2,alpha=.05) + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   scale_x_discrete("Random error Y") + -->
<!--   scale_y_continuous("RMSE") + -->
<!--   facet_nested(SparsMethod ~ beta.params) + -->
<!--   theme_bw() + -->
<!--   theme(text = element_text(size=12)) -->
<!-- ggsave(file = paste0(sim.path, "/fig_rmse_epsg_nested_beta_sparsmethods_filter_epsG0.2.tiff"),  -->
<!--        width=1.5*200, height=1*200, units="mm", dpi=350, compression = "lzw") -->
<!-- ``` -->

<!-- ```{r, echo=F, warning=F, message=F,  fig.align='center', fig.width=10, fig.height=6, fig.cap="Nested line plot for RMSE for beta.params c(4,2)"} -->
<!-- tbl_scens %>% -->
<!--   filter(beta.params %in% "c(4, 2)") %>% -->
<!--   mutate_at(vars(beta.params, SparsMethod, AnaMethod), as.factor) %>% -->
<!--   mutate(eps.g = paste0("eps G = ", eps.g)) %>% -->
<!--   ggplot(aes(x=eps.y, y=RMSE.est, group=AnaMethod, col=AnaMethod)) + -->
<!--   geom_ribbon(aes(x=eps.y, ymax=RMSE.up, ymin=RMSE.lo, fill=AnaMethod), linetype=2,alpha=.05) + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   scale_x_discrete("Random error Y") + -->
<!--   scale_y_continuous("RMSE") + -->
<!--   facet_nested(eps.g ~ SparsMethod + ThreshMethod) + -->
<!--   theme_bw() + -->
<!--   theme(text = element_text(size=12)) -->
<!-- ggsave(file = paste0(sim.path, "/fig_rmse_epsg_nested_beta_sparsmethods_filter_epsG0.2.tiff"),  -->
<!--        width=1.5*200, height=1*200, units="mm", dpi=350, compression = "lzw") -->
<!-- ``` -->