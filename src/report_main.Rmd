---
title: 'PRONET - Simulation study'
author: "Mariella Gregorich"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::html_document2:
    css: "css_style.css"
    theme: cosmo
    number_sections: true
    keep_md: no
    fig_caption: true
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: 
      collapsed: true
      smooth_scroll: true
    highlight: tango
---


```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = F, warning=F, message=F)

source(here::here("src","functions_main.R"))
source(here::here("src","functions_aux.R"))
source(here::here("src","setup.R"))

# Paths
out.path <- "output"
sim.date <- "2022-10-19" # Sys.Date()
sim.file <- paste0("sim_", sim.date,"/")
sim.path <- here::here(out.path, sim.file)
ggcols <- c("black", "grey60","deepskyblue3", "royalblue3", "mediumorchid3")
nfig=1

# Read in results

tbl_res <- readRDS(here::here(sim.path, "tbl_scenario_results.rds"))

tbl_scens <- tbl_res$tbl_scens %>%
  mutate_at(vars(eps.g, eps.y, n, p), as.numeric) %>% 
  mutate_at(vars(dg.thresh, epslevel.g, epslevel.y, n, p), as.factor) %>%
  mutate(dg.thresh = fct_relevel(dg.thresh, c("single", "random", "flat", "half-sine", "sine"))) %>%
  mutate(AnaMethod = fct_relevel(AnaMethod, c("Oracle", "Null", "OPT", "AVG", "FLEX"))) 

tbl_funs <- tbl_res$tbl_funs %>%
  mutate_at(vars(n, p), as.numeric) %>% 
  mutate_at(vars(dg.thresh, epslevel.g, epslevel.y, n, p), as.factor) %>%
  mutate(dg.thresh = fct_relevel(dg.thresh, c("single", "random", "flat", "half-sine", "sine")))

tbl_tfreq <- tbl_res$tbl_tfreq %>%
  mutate_at(vars(n, p), as.numeric) %>% 
  mutate_at(vars(dg.thresh, epslevel.g, epslevel.y, n, p), as.factor) %>%
  mutate(dg.thresh = fct_relevel(dg.thresh, c("single", "random", "flat", "half-sine", "sine")))

tbl_funcoeff <- tbl_res$tbl_funcoeff %>%
  mutate_at(vars(n, p), as.numeric) %>% 
  mutate_at(vars(dg.thresh, epslevel.g, epslevel.y, n, p), as.factor) %>%
  mutate(dg.thresh = fct_relevel(dg.thresh, c("single", "random", "flat", "half-sine", "sine")))

tbl_graph <- tbl_res$tbl_graph %>%
  group_by(network.model) %>%
  slice(1)

```


# Simulation setup info

The following parameter were included to create the semi-factorial simulation setup:
```{r echo=FALSE}
tmp <- read.table(here::here(sim.path, list.files(sim.path, pattern = "info_")[1]))
tmp <- str_split_fixed(tmp[27:52,], pattern = "#", n=2)
  
tmp %>% 
  data.frame() %>%
  `colnames<-`(c("Code", "Explanation")) %>%
  kbl(caption="Parameters for the semi-factorial simulation setup", escape = F) %>%
  kable_classic(full_width = T, html_font = "Calibri")%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left",fixed_thead = T)
```



# Results

## Network structure

```{r, fig.align='center', fig.width=6, fig.height=4, fig.cap="Scale-free Barabasi-Albert default network structure", fig.fullwidth = TRUE}
mat1 <- as.matrix(tbl_graph[1,]$data[[1]])
mat2 <- as.matrix(tbl_graph[2,]$data[[1]])
mat3 <- as.matrix(tbl_graph[3,]$data[[1]])

#tiff(file = paste0(sim.path, "/fig_BAgraph_structure.tiff"),  width=1.75*200, height=1*200, units="mm", res=350, compression = "lzw")
i1 <- image(mat1, main="scale-free", col = c("white", "black"), axes=F)
i2 <- image(mat2, main="small-world", col = c("white", "black"), axes=F)
i3 <- image(mat3, main="random", col = c("white", "black"), axes=F)
cowplot::plot_grid(i1,i2,i3, ncol=3)
 #dev.off()
```


## RMSE

### Figures


```{r, fig.align='center', fig.width=14, fig.height=10, fig.cap="", fig.fullwidth = TRUE}
cond <- quo((SparsMethod == "weight-based" & network.model=="random" & epslevel.g=="none") & 
                     ((adjust==F & setting %in% c("uni"))| (adjust==T & setting %in% c("latent", "multi"))))
cond_sub <- str_remove_all(as.character(cond)[2], "[[:punct:]]")
cond_sub <- str_replace_all(cond_sub, "  ", ", ")
cond_sub <- str_replace_all(cond_sub, "==", "=")

tbl_loo1 <- tbl_scens %>%
  filter(!!cond) %>%
  dplyr::select(setting,n, dg.thresh, epslevel.y, AnaMethod, RMSE.med) %>%
  pivot_wider(id_cols = c(setting, n, dg.thresh, epslevel.y), names_from = AnaMethod, values_from = RMSE.med) %>% 
  mutate(n = as.factor(n)) %>%
  rename("DGM"="dg.thresh")

p = nested_loop_plot(resdf = tbl_loo1,
                     x = "n", steps = "epslevel.y",
                     grid_rows="setting", grid_cols = "DGM",
                     steps_y_base = min(tbl_loo1$OPT)-0.35, steps_y_height = 0.15,
                     steps_names = "Noise(Y)",
                     x_name = "Sample size", y_name = "aRMSE",
                     spu_x_shift = 1.5,
                     colors = ggcols,
                     grid_scales = "free_y",
                     steps_values_annotate = TRUE, steps_annotation_size = 4,
                     hline_intercept = min(tbl_loo1$OPT),
                     y_expand_add = c(1, 0.25),
                     post_processing = list(
                         add_custom_theme = list(
                           text=element_text(size=22),
                             axis.text.x = element_text(size = 14,
                                                        angle = -90,
                                                        vjust = 0.5)
                         )
                     )) + 
  ggtitle(label = paste0("Figure 2.", nfig),
          subtitle = paste0("Filter: ", cond_sub)) + 
  theme(
  plot.title = element_text(size = 22, face = "bold"),
  plot.subtitle = element_text(size = 16)) 
nfig = nfig+1
print(p)
ggsave(file = paste0(sim.path, "/fig_loo_RMSE_epsY.tiff"),
       width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw")
```

<br>

```{r, fig.align='center', fig.width=12, fig.height=6, fig.cap="", fig.fullwidth = TRUE}
cond <- quo((SparsMethod == "weight-based" & network.model=="random" & epslevel.g=="none") & dg.thresh %in% c("single", "random", "half-sine") &
                     ((adjust==F & setting %in% c("uni"))))
cond_sub <- str_remove_all(as.character(cond)[2], "[[:punct:]]")
cond_sub <- str_replace_all(cond_sub, "  ", ", ")
cond_sub <- str_replace_all(cond_sub, "==", "=")

tbl_loo1 <- tbl_scens %>%
  filter(!!cond) %>%
  dplyr::select(setting,n, dg.thresh, epslevel.y, AnaMethod, RMSE.med) %>%
  pivot_wider(id_cols = c(setting, n, dg.thresh, epslevel.y), names_from = AnaMethod, values_from = RMSE.med) %>% 
  mutate(n = as.factor(n)) %>%
  rename("DGM"="dg.thresh")

p = nested_loop_plot(resdf = tbl_loo1,
                     x = "n", steps = "epslevel.y",
                     grid_rows="setting", grid_cols = "DGM",
                     steps_y_base = min(tbl_loo1$OPT)-0.35, steps_y_height = 0.15,
                     steps_names = "Noise(Y)",
                     x_name = "Sample size", y_name = "aRMSE",
                     spu_x_shift = 1.5,
                     colors = ggcols,
                     grid_scales = "free_y",
                     steps_values_annotate = TRUE, steps_annotation_size = 6,
                     hline_intercept = min(tbl_loo1$OPT),
                     y_expand_add = c(0.5, 0.25),
                     post_processing = list(
                         add_custom_theme = list(
                           text=element_text(size=28),
                             axis.text.x = element_text(size = 20,
                                                        angle = -90,
                                                        vjust = 0.5)
                         )
                     )) 
print(p)
ggsave(file = paste0(sim.path, "/fig_loo_RMSE_epsY_red.tiff"),
       width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw")
```

<br>

```{r, fig.align='center', fig.width=14, fig.height=10, fig.cap="", fig.fullwidth = TRUE}
cond <- quo((SparsMethod == "weight-based" & network.model=="scale-free" & epslevel.y=="none") & 
                     ((adjust==F & setting %in% c("uni"))| (adjust==T & setting %in% c("latent", "multi"))))
cond_sub <- str_remove_all(as.character(cond)[2], "[[:punct:]]")
cond_sub <- str_replace_all(cond_sub, "  ", ", ")
cond_sub <- str_replace_all(cond_sub, "==", "=")

tbl_loo1 <- tbl_scens %>%
  filter(!!cond) %>%
  dplyr::select(setting, n, dg.thresh, epslevel.g, AnaMethod, RMSE.med) %>%
  pivot_wider(id_cols = c(setting, n, dg.thresh, epslevel.g), names_from = AnaMethod, values_from = RMSE.med) %>% 
  mutate(n = as.factor(n)) %>%
  rename("DGM"="dg.thresh")

p = nested_loop_plot(resdf = tbl_loo1,
                     x = "n", steps = "epslevel.g",
                     grid_rows="setting", grid_cols = "DGM",
                     steps_y_base = min(tbl_loo1$OPT)-0.25, steps_y_height = 0.05,
                     steps_names = "Noise(G)",
                     x_name = "Sample size", y_name = "aRMSE",
                     spu_x_shift = 1.5,
                     colors = ggcols,
                     grid_scales = "free_y",
                     ylim = c(0,2.5),
                     steps_values_annotate = TRUE, steps_annotation_size = 4,
                     hline_intercept = min(tbl_loo1$OPT),
                     y_expand_add = c(0.75, 0.15),
                     post_processing = list(
                         add_custom_theme = list(
                           text=element_text(size=22),
                             axis.text.x = element_text(size = 14,
                                                        angle = -90,
                                                        vjust = 0.5)
                         )
                     )) + 
  ggtitle(label = paste0("Figure 2.", nfig),
          subtitle = paste0("Filter: ", cond_sub)) + 
  theme(
  plot.title = element_text(size = 22, face = "bold"),
  plot.subtitle = element_text(size = 16))
nfig = nfig+1
print(p)
ggsave(file = paste0(sim.path, "/fig_loo_RMSE_epsG.tiff"),
       width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw")
```

<br>



<br>

```{r, fig.align='center', fig.width=12, fig.height=6, fig.cap="", fig.fullwidth = TRUE}
cond <- quo((SparsMethod == "weight-based" & network.model=="random" & epslevel.y=="none") & dg.thresh %in% c("single", "random", "half-sine") &
                     ((adjust==F & setting %in% c("uni"))))
cond_sub <- str_remove_all(as.character(cond)[2], "[[:punct:]]")
cond_sub <- str_replace_all(cond_sub, "  ", ", ")
cond_sub <- str_replace_all(cond_sub, "==", "=")

tbl_loo1 <- tbl_scens %>%
  filter(!!cond) %>%
  dplyr::select(setting,n, dg.thresh, epslevel.g, AnaMethod, RMSE.med) %>%
  pivot_wider(id_cols = c(setting, n, dg.thresh, epslevel.g), names_from = AnaMethod, values_from = RMSE.med) %>% 
  mutate(n = as.factor(n)) %>%
  rename("DGM"="dg.thresh")

p = nested_loop_plot(resdf = tbl_loo1,
                     x = "n", steps = "epslevel.g",
                     grid_rows="setting", grid_cols = "DGM",
                     steps_y_base = min(tbl_loo1$OPT)-0.35, steps_y_height = 0.15,
                     steps_names = "Noise(Y)",
                     x_name = "Sample size", y_name = "aRMSE",
                     spu_x_shift = 1.5,
                     colors = ggcols,
                     grid_scales = "free_y",
                     steps_values_annotate = TRUE, steps_annotation_size = 6,
                     hline_intercept = min(tbl_loo1$OPT),
                     y_expand_add = c(0.4, 0.25),
                     post_processing = list(
                         add_custom_theme = list(
                           text=element_text(size=28),
                             axis.text.x = element_text(size = 20,
                                                        angle = -90,
                                                        vjust = 0.5)
                         )
                     )) 
print(p)
ggsave(file = paste0(sim.path, "/fig_loo_RMSE_epsG_red.tiff"),
       width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw")
```

<br>
```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=14, fig.height=10, fig.cap="", fig.fullwidth = TRUE}
cond <- quo((SparsMethod == "weight-based" & network.model=="random" & epslevel.y=="none") & 
            ((adjust==F & setting %in% c("uni"))| (adjust==F & setting %in% c("latent", "multi"))))
cond_sub <- str_remove_all(as.character(cond)[2], "[[:punct:]]")
cond_sub <- str_replace_all(cond_sub, "  ", ", ")
cond_sub <- str_replace_all(cond_sub, "==", "=")

tbl_loo1 <- tbl_scens %>%
  filter(!!cond) %>%
  dplyr::select(setting, n, dg.thresh, epslevel.g, AnaMethod, RMSE.med) %>%
  pivot_wider(id_cols = c(setting, n, dg.thresh, epslevel.g), names_from = AnaMethod, values_from = RMSE.med) %>% 
  mutate(n = as.factor(n)) %>%
  rename("DGM"="dg.thresh")


p = nested_loop_plot(resdf = tbl_loo1,
                     x = "n", steps = "epslevel.g",
                     grid_rows="setting", grid_cols = "DGM",
                     steps_y_base = min(tbl_loo1$OPT)-0.15, steps_y_height = 0.15,
                     steps_names = "Noise(G)",
                     x_name = "Sample size", y_name = "aRMSE",
                     spu_x_shift = 1.5,
                     colors = ggcols,
                     grid_scales = "free_y",
                     ylim = c(0,2.5),
                     steps_values_annotate = TRUE, steps_annotation_size = 4,
                     hline_intercept = min(tbl_loo1$OPT),
                     y_expand_add = c(0.5, 0.05),
                     post_processing = list(
                         add_custom_theme = list(
                           text=element_text(size=22),
                             axis.text.x = element_text(size = 14,
                                                        angle = -90,
                                                        vjust = 0.5)
                         )
                     )) + 
  ggtitle(label = paste0("Figure 2.", nfig),
          subtitle = paste0("Filter: ", cond_sub)) + 
  theme(
  plot.title = element_text(size = 22, face = "bold"),
  plot.subtitle = element_text(size = 16))
nfig = nfig+1
print(p)

```


<br>

```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=12, fig.height=6, fig.cap="", fig.fullwidth = TRUE}
cond <- quo((SparsMethod == "weight-based") & network.model=="random" & n==300 & epslevel.y=="none" &
                     ((adjust==F & setting %in% c("uni"))| (adjust==T & setting %in% c("latent", "multi"))))
cond_sub <- str_remove_all(as.character(cond)[2], "[[:punct:]]")
cond_sub <- str_replace_all(cond_sub, "  ", ", ")
cond_sub <- str_replace_all(cond_sub, "==", "=")

tbl_gg1 <- tbl_scens %>%
  filter(!!cond) %>%
  dplyr::select(setting, dg.thresh, epslevel.g, AnaMethod, RMSE.med, RMSE.lo, RMSE.up) %>%
  rename("DGM"="dg.thresh")

tbl_gg1 %>%
  ggplot(aes(x=epslevel.g, y=RMSE.med, group=AnaMethod, col=AnaMethod)) +
  geom_point() +
  geom_line() +
  scale_y_continuous("aRMSE") +
  scale_x_discrete("Noise(G)") +
  scale_color_manual(values=ggcols) +
  facet_grid(setting~DGM, labeller = label_both) +
  theme_bw() +
  theme(text=element_text(size=16),
                             axis.text.x = element_text(size = 10)) + 
  ggtitle(label = paste0("Figure 2.", nfig),
          subtitle = paste0("Filter: ", cond_sub)) + 
  theme(
  plot.title = element_text(size = 18, face = "bold"),
  plot.subtitle = element_text(size = 12))
nfig = nfig+1
ggsave(file = paste0(sim.path, "/fig_loo_RMSE_epsG_partial2.tiff"),
       width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw")
```


<br>

```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=12, fig.height=8, fig.cap="", fig.fullwidth = TRUE}
cond <- quo((SparsMethod == "weight-based" & network.model=="random" & n==300) & 
                     ((adjust==F & setting %in% c("uni"))| (adjust==T & setting %in% c("latent", "multi"))))
cond_sub <- str_remove_all(as.character(cond)[2], "[[:punct:]]")
cond_sub <- str_replace_all(cond_sub, "  ", ", ")
cond_sub <- str_replace_all(cond_sub, "==", "=")

tbl_loo6 <- tbl_scens %>%
  filter(!!cond) %>%
  dplyr::select(setting, epslevel.y, dg.thresh, epslevel.g, AnaMethod, RMSE.med) %>%
  pivot_wider(id_cols = c(setting, epslevel.y, dg.thresh, epslevel.g), names_from = AnaMethod, values_from = RMSE.med) %>% 
  rename("DGM"="dg.thresh")

p = nested_loop_plot(resdf = tbl_loo6,
                     x = "epslevel.g", steps = "epslevel.y",
                     grid_rows="setting", grid_cols = "DGM",
                     steps_y_base = min(tbl_loo1$OPT)-0.5, steps_y_height = 0.15,
                     steps_names = "Noise(Y)",
                     x_name = "Noise(G)", y_name = "aRMSE",
                     spu_x_shift = 1.5,
                     colors = ggcols,
                     steps_values_annotate = TRUE, steps_annotation_size = 3,
                     hline_intercept = min(tbl_loo1$OPT),
                     y_expand_add = c(0.75, 0.05),
                     post_processing = list(
                         add_custom_theme = list(
                           text=element_text(size=16),
                             axis.text.x = element_text(size = 10,
                                                        angle = -90,
                                                        vjust = 0.5)
                         )
                     ))+ 
  ggtitle(label = paste0("Figure 2.", nfig),
          subtitle = paste0("Filter: ", cond_sub)) + 
  theme(
  plot.title = element_text(size = 18, face = "bold"),
  plot.subtitle = element_text(size = 12))
nfig = nfig+1
p
ggsave(file = paste0(sim.path, "/fig_loo_RMSE_epsG.tiff"),
       width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw")
```



<br>

### Tables
```{r}
tbl_scens %>%
  filter(n==300 & SparsMethod == "weight-based" & network.model=="random" & epslevel.g == "none" & epslevel.y == "none") %>%
  dplyr::select(dg.thresh, setting, adjust, AnaMethod, RMSE.med, RMSE.lo, RMSE.up) %>%
  rename("DGM"="dg.thresh") %>%
  mutate_at(vars(RMSE.med, RMSE.lo, RMSE.up), round_0, digits=2) %>%
  mutate(RMSE=paste0(RMSE.med, " (", RMSE.lo, " ,", RMSE.up, ")")) %>%
  select(DGM, setting, adjust, AnaMethod, RMSE) %>%
  pivot_wider(names_from = AnaMethod, values_from = RMSE) %>%
  relocate(setting, .before=DGM) %>%
  mutate(DGM=fct_relevel(DGM, "single", "random", "flat", "half-sine", "sine")) %>%
  arrange(setting, adjust,DGM) %>%
  kbl(caption="aRMSE acrosss setings and data-generating mechanisms with 95% CI: no noise(G) and noise(Y)", escape = F) %>%
  row_spec(0, bold = T) %>%
  column_spec(1, bold=T) %>%
  column_spec(c(3), border_right = T) %>%
 # row_spec(c(5,10,15,20), extra_css ="border-bottom: 1px solid") %>%
  kable_classic(full_width = T, html_font = "Calibri")%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left",fixed_thead = T)
```

<br>

```{r}
tbl_scens %>%
  filter(n==300 & SparsMethod == "weight-based" & network.model=="random" & epslevel.g == "none" & epslevel.y == "high") %>%
  dplyr::select(dg.thresh, setting, adjust, AnaMethod, RMSE.med, RMSE.lo, RMSE.up) %>%
  rename("DGM"="dg.thresh") %>%
  mutate_at(vars(RMSE.med, RMSE.lo, RMSE.up), round_0, digits=2) %>%
  mutate(RMSE=paste0(RMSE.med, " (", RMSE.lo, " ,", RMSE.up, ")")) %>%
  select(DGM, setting, adjust, AnaMethod, RMSE) %>%
  pivot_wider(names_from = AnaMethod, values_from = RMSE) %>%
  relocate(setting, .before=DGM) %>%
  mutate(DGM=fct_relevel(DGM, "single", "random", "flat", "half-sine", "sine")) %>%
  arrange(setting, adjust ,DGM) %>%
  kbl(caption="aRMSE acrosss setings and data-generating mechanisms with 95% CI: no noise(G) and high noise(Y)", escape = F) %>%
  row_spec(0, bold = T) %>%
  column_spec(1, bold=T) %>%
  column_spec(c(3), border_right = T) %>%
  row_spec(c(5,10,15), extra_css ="border-bottom: 1px solid") %>%
  kable_classic(full_width = T, html_font = "Calibri")%>%
  kable_classic(full_width = T, html_font = "Calibri")%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left",fixed_thead = T)
```

<br>



```{r}
tbl_scens %>%
  filter(n==300 & SparsMethod == "weight-based" & network.model=="random" & epslevel.g == "high" & epslevel.y == "none") %>%
  dplyr::select(dg.thresh, setting, adjust, AnaMethod, RMSE.med, RMSE.lo, RMSE.up) %>%
  rename("DGM"="dg.thresh") %>%
  mutate_at(vars(RMSE.med, RMSE.lo, RMSE.up), round_0, digits=2) %>%
  mutate(RMSE=paste0(RMSE.med, " (", RMSE.lo, " ,", RMSE.up, ")")) %>%
  select(DGM, setting, adjust, AnaMethod, RMSE) %>%
  pivot_wider(names_from = AnaMethod, values_from = RMSE) %>%
  relocate(setting, .before=DGM) %>%
  mutate(DGM=fct_relevel(DGM, "single", "random", "flat", "half-sine", "sine")) %>%
  arrange(setting, adjust ,DGM) %>%
  kbl(caption="aRMSE acrosss setings and data-generating mechanisms with 95% CI: high noise(G) and no noise(Y)", escape = F) %>%
  row_spec(0, bold = T) %>%
  column_spec(1, bold=T) %>%
  column_spec(c(3), border_right = T) %>%
  row_spec(c(5,10,15,20), extra_css ="border-bottom: 1px solid") %>%
  kable_classic(full_width = T, html_font = "Calibri")%>%
  kable_classic(full_width = T, html_font = "Calibri")%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left",fixed_thead = T)
```


### Summary

Based on the figures and tables, we can see:

* equivalent performance of methods if neither noise for G nor Y
* if noise(G), then FLEX best
* varying sample size and number of nodes yield no changes
* varying b-parameters yield no changes

## R2

```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=12, fig.height=8, fig.cap="", fig.fullwidth = TRUE}
cond <- quo((SparsMethod == "weight-based" & network.model=="random" & epslevel.g=="none") & 
                     ((adjust==F & setting %in% c("uni"))| (adjust==T & setting %in% c("latent", "multi"))))
cond_sub <- str_remove_all(as.character(cond)[2], "[[:punct:]]")
cond_sub <- str_replace_all(cond_sub, "  ", ", ")
cond_sub <- str_replace_all(cond_sub, "==", "=")

tbl_loo1 <- tbl_scens %>%
  filter(!!cond) %>%
  dplyr::select(setting,  n, dg.thresh, epslevel.y, AnaMethod, R2.est) %>%
  pivot_wider(id_cols = c(setting, n, dg.thresh, epslevel.y), names_from = AnaMethod, values_from = R2.est) %>% 
  mutate(n = as.factor(n)) %>%
  rename("DGM"="dg.thresh")

p = nested_loop_plot(resdf = tbl_loo1,
                     x = "n", steps = "epslevel.y",
                     grid_rows="setting", grid_cols = "DGM",
                     steps_y_base = min(tbl_loo1$OPT)-1.5, steps_y_height = 0.25,
                     steps_names = "Noise(Y)",
                     x_name = "Sample size", y_name = "aR2",
                     spu_x_shift = 1.5,
                     ylim = c(0,1), y_breaks = seq(0,1,0.25),
                     colors = ggcols,
                     steps_values_annotate = TRUE, steps_annotation_size = 3,
                     hline_intercept = c(0,0.3, 0.6, 1),
                     y_expand_add = c(0.2, 0.05),
                     post_processing = list(
                         add_custom_theme = list(
                           text=element_text(size=16),
                             axis.text.x = element_text(angle = -90,
                                                        vjust = 0.5,
                                                        size = 10)
                         )
                     )) + 
  ggtitle(label = paste0("Figure 2.", nfig),
          subtitle = paste0("Filter: ", cond_sub)) + 
  theme(
  plot.title = element_text(size = 18, face = "bold"),
  plot.subtitle = element_text(size = 12))
nfig = nfig+1
print(p)
ggsave(file = paste0(sim.path, "/fig_loo_R2_epsY.tiff"),
       width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw")
```

<br>

```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=12, fig.height=8, fig.cap="", fig.fullwidth = TRUE}
cond <- quo((SparsMethod == "weight-based" & network.model=="random" & epslevel.y=="none") & 
                     ((adjust==F & setting %in% c("uni"))| (adjust==T & setting %in% c("latent", "multi"))))
cond_sub <- str_remove_all(as.character(cond)[2], "[[:punct:]]")
cond_sub <- str_replace_all(cond_sub, "  ", ", ")
cond_sub <- str_replace_all(cond_sub, "==", "=")

tbl_loo1 <- tbl_scens %>%
  filter(!!cond) %>%
  dplyr::select(setting,  n, dg.thresh, epslevel.g, AnaMethod, R2.est) %>%
  pivot_wider(id_cols = c(setting, n, dg.thresh, epslevel.g), names_from = AnaMethod, values_from = R2.est) %>% 
  mutate(n = as.factor(n)) %>%
  rename("DGM"="dg.thresh")

p = nested_loop_plot(resdf = tbl_loo1,
                     x = "n", steps = "epslevel.g",
                     grid_rows="setting", grid_cols = "DGM",
                     steps_y_base = min(tbl_loo1$OPT)-1.5, steps_y_height = 0.25,
                     steps_names = "Noise(G)",
                     x_name = "Sample size", y_name = "aR2",
                     spu_x_shift = 1.5,
                     ylim = c(0,1), y_breaks = seq(0,1,0.25),
                     colors = ggcols,
                     steps_values_annotate = TRUE, steps_annotation_size = 3,
                     hline_intercept = c(0,0.6, 0.8, 1),
                     y_expand_add = c(0.2, 0.05),
                     post_processing = list(
                         add_custom_theme = list(
                           text=element_text(size=16),
                             axis.text.x = element_text(angle = -90,
                                                        vjust = 0.5,
                                                        size = 10)
                         )
                     )) + 
  ggtitle(label = paste0("Figure 2.", nfig),
          subtitle = paste0("Filter: ", cond_sub)) + 
  theme(
  plot.title = element_text(size = 18, face = "bold"),
  plot.subtitle = element_text(size = 12))
nfig = nfig+1
print(p)
ggsave(file = paste0(sim.path, "/fig_loo_R2_epsG.tiff"),
       width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw")
```


<br>

# Scenarios

## Single or random threshold selection in DG

In the following section, only the OPT analysis method is examined in more detail. Namely, the frequency of the selected threshold is investigated. For each data generation mechanism, the weighted mean threshold is calculated by weighting the mean value of the thresholds with the number of selections.

```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=12, fig.height=8, fig.cap="Averaged threshold selection of the OPT approach with sequential weight-based sparsification under different data-generating mechanisms. The average threshold was calculated by a weighted mean with weights corresponding to the proportion of selection over the iterations."}
cond <- quo(SparsMethod == "weight-based" & network.model=="random" & setting =="uni" & adjust==F & dg.thresh %in% c("single"))
cond_sub <- str_remove_all(as.character(cond)[2], "[[:punct:]]")
cond_sub <- str_replace_all(cond_sub, "  ", ", ")
cond_sub <- str_replace_all(cond_sub, "==", "=")

tbl_tfreq_loo <- tbl_tfreq  %>%
  filter(!!cond) %>%
  mutate_at(vars(Thresh, count), as.numeric) %>%
  group_by(n, p, dg.thresh, epslevel.g, epslevel.y) %>%
  summarise(wmean = weighted.mean(Thresh, count)) %>%
  pivot_wider(id_cols = c(n, p, epslevel.y, epslevel.g), names_from = dg.thresh, values_from = wmean) %>%
  rename("Noise(Y)"=epslevel.y)


p = nested_loop_plot(resdf = tbl_tfreq_loo,
                     x = "n", steps = "epslevel.g",
                     grid_rows = "p", grid_cols = "Noise(Y)",
                     steps_y_base = 0.1, steps_y_height = 0.01,
                     x_name = "Sample size", 
                     y_name = "Average selected threshold",
                     steps_names = "Noise(G)",
                     spu_x_shift = 1.5,
                     legend_name = "DGM",
                     ylim = c(0.1,0.4), y_breaks = seq(0.1,0.4,0.05),
                     colors = scales::brewer_pal(palette = "Set1"),
                     steps_values_annotate = TRUE, steps_annotation_size = 3,
                     hline_intercept = 0.25,
                     y_expand_add = c(0.05, 0.005),
                     post_processing = list(
                         add_custom_theme = list(
                           text=element_text(size=14),
                             axis.text.x = element_text(angle = -90,
                                                        vjust = 0.5,
                                                        size = 12)
                         )
                     ))
print(p)
ggsave(file = paste0(sim.path, "/fig_loo_OPT_freq_wb_p150_single.tiff"),
       width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw")
```
<br>

```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=10, fig.height=4, fig.cap="Averaged threshold selection of the OPT approach with sequential weight-based sparsification under different data-generating mechanisms. The average threshold was calculated by a weighted mean with weights corresponding to the proportion of selection over the iterations."}
tbl_loo5 <- tbl_tfreq  %>%
  filter(SparsMethod == "weight-based" & network.model=="random" & setting =="uni" & adjust==F & dg.thresh %in% c("single")) %>%
  mutate_at(vars(Thresh, count), as.numeric) %>%
  group_by(n, dg.thresh, epslevel.g, epslevel.y) %>%
  summarise(wmean = weighted.mean(Thresh, count)) %>%
  pivot_wider(id_cols = c(n, epslevel.y, epslevel.g), names_from = dg.thresh, values_from = wmean) %>%
  rename("Noise(Y)"=epslevel.y)


p = nested_loop_plot(resdf = tbl_loo5,
                     x = "n", steps = "epslevel.g",
                     grid_cols = "Noise(Y)",
                     steps_y_base = 0.075, steps_y_height = 0.005,
                     x_name = "Sample size", 
                     y_name = "Average selected threshold",
                     steps_names = "Noise(G)",
                     spu_x_shift = 2,
                     legend_name = "DGM",
                     ylim = c(0.1,0.4), y_breaks = seq(0.1,0.4,0.05),
                     colors = scales::brewer_pal(palette = "Set1"),
                     steps_values_annotate = TRUE, steps_annotation_size = 6,
                     hline_intercept = 0.25,
                     hline_colour = "red",
                     hline_linetype = 2,
                     y_expand_add = c(0.075, 0.005),
                     post_processing = list(
                         add_custom_theme = list(
                           legend.position="top",
                           text=element_text(size=20),
                             axis.text.x = element_text(angle = -90,
                                                        vjust = 0.55,
                                                        size = 12)
                         )
                     ))
print(p)
ggsave(file = paste0(sim.path, "/fig_loo_OPT_freq_wb_p150_single_epsG.tiff"),
       width=1.75*200, height=0.75*200, units="mm", dpi=350, compression = "lzw")
```


<br>

```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=10, fig.height=5, fig.cap="Averaged threshold selection of the AVG approach with sequential weight-based sparsification under different data-generating mechanisms. The average threshold was calculated by a weighted mean with weights corresponding to the proportion of selection over the iterations."}
tbl_tfreq_loo <- tbl_tfreq  %>%
  filter(SparsMethod == "weight-based" & network.model=="random" & setting =="uni" & adjust==F & dg.thresh %in% "random") %>%
  mutate_at(vars(Thresh, count), as.numeric) %>%
  group_by(n, dg.thresh, epslevel.g, epslevel.y) %>%
  summarise(wmean = weighted.mean(Thresh, count)) %>%
  pivot_wider(id_cols = c(n, epslevel.y, epslevel.g), names_from = dg.thresh, values_from = wmean) %>%
  rename("Noise(Y)"=epslevel.y)


p = nested_loop_plot(resdf = tbl_tfreq_loo,
                     x = "n", steps = "epslevel.g",
                     grid_cols = "Noise(Y)",
                     steps_y_base = 0.075, steps_y_height = 0.0025,
                     x_name = "Sample size", 
                     y_name = "Average selected threshold",
                     steps_names = "Noise(G)",
                     spu_x_shift = 2,
                     legend_name = "DGM",
                     ylim = c(0.1,0.45), y_breaks = seq(0.1,0.45,0.05),
                     colors = "blue",
                     steps_values_annotate = TRUE, steps_annotation_size = 5,
                     hline_intercept = c(0.1,0.4),
                     hline_colour = "blue",
                     y_expand_add = c(0.065, 0.005),
                     post_processing = list(
                         add_geom_at_position = list(
                             g = geom_rect(
                                 data = NULL,
                                 xmin = -Inf, xmax = Inf, 
                                 ymin = 0.1, ymax = 0.4, 
                                 alpha = 0.005, fill = "blue",
                                 linetype = "blank",
                                 inherit.aes = FALSE
                             ),
                             position = "bottom" # place below other geometries
                         ),
                         add_custom_theme = list(
                             axis.text.x = element_text(angle = -90, 
                                                        vjust = 0.5, 
                                                        size = 12) 
                         )
                     ))
print(p)
ggsave(file = paste0(sim.path, "/fig_loo_OPT_freq_wb_p200.tiff"),
       width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw")
```

<br>

```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=12, fig.height=8, fig.cap="Threshold selection of the OPT approach with sequential density-based sparsification under different data-generating mechanisms. The average threshold was calculated by a weighted mean with weights corresponding to the proportion of selection over the iterations."}
tbl_tfreq_loo <- tbl_tfreq  %>%
  filter(SparsMethod == "weight-based" & network.model=="random" & setting =="uni" & adjust==F) %>%
  mutate_at(vars(Thresh, count), as.numeric) %>%
  group_by(n, p, dg.thresh, epslevel.g, epslevel.y) %>%
  summarise(wmean = weighted.mean(Thresh, count)) %>%
  pivot_wider(id_cols = c(n, p, epslevel.y, epslevel.g), names_from = dg.thresh, values_from = wmean) %>%
  rename("Noise(Y)"=epslevel.y)


p = nested_loop_plot(resdf = tbl_tfreq_loo,
                     x = "n", steps = "epslevel.g",
                     grid_rows = "p", grid_cols = "Noise(Y)",
                     steps_y_base = 0.075, steps_y_height = 0.025,
                     x_name = "Sample size", 
                     y_name = "Average selected threshold",
                     steps_names = "Noise(G)",
                     spu_x_shift = 1.5,
                     legend_name = "DGM",
                     ylim = c(0.1,0.5), y_breaks = seq(0.1,0.5,0.1),
                     colors = scales::brewer_pal(palette = "Set1"),
                     steps_values_annotate = TRUE, steps_annotation_size = 5,
                     hline_intercept = c(0.25),
                     y_expand_add = c(0.15, 0.05),
                     post_processing = list(
                         add_custom_theme = list(
                           text=element_text(size=22),
                             axis.text.x = element_text(angle = -90,
                                                        vjust = 0.5,
                                                        size = 18)
                         )
                     ))
print(p)
ggsave(file = paste0(sim.path, "/fig_loo_OPT_freq_wb.tiff"),
       width=1.75*200, height=0.75*200, units="mm", dpi=350, compression = "lzw")
```

## Functional form for DG

In the following selection, the three functional forms for data generation using the sequence of graph-theoretical features are first illustrated. In the following, the average RMSE function for each threshold value t is first calculated in an unstandardized and then in a standardized way. The calculation is performed for each threshold t by taking the root of the mean squared difference between the true beta(t) value at t and the estimated over all iterations.

```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=5, fig.height=3, fig.cap="The three true functional forms used in the data-generating mechanism to generated the outcome based on a graph-theoretical feature sequence derived by sequential weight-based sparsification"}
b1 <- as.numeric(tbl_scens$b1[1])
thr.grid = seq(0,1,0.02)
true.flat = rep(b1*2,length(thr.grid))
true.halfsine = sin(thr.grid*pi)*b1*2
true.sine = sin(thr.grid*pi*4)*b1*2
true_fun <- data.frame("thresh"= thr.grid,
                       "flat"= true.flat,
                       "half-sine"=true.halfsine,
                       "sine"=true.sine)
true_fun_melted <- melt(true_fun, id.vars = "thresh") %>%
  rename("DGM"=variable) %>%
  mutate(DGM=fct_recode(DGM, "half-sine"="half.sine"))

ggplot(true_fun_melted, aes(x=thresh, y=value)) +
  geom_line(col="blue") +
  ggtitle("True functional form of data generation") +
  facet_grid(~ DGM, labeller = label_both) +
  theme_bw() +
  scale_x_continuous("Threshold t") +
  scale_y_continuous(paste0("Coeficient function \u03b2(t)")) +
  theme(text = element_text(size=12),
                             axis.text.x = element_text(angle = 45,
                                                        vjust = 0.5,
                                                        size = 12))
ggsave(file = paste0(sim.path, "/fig_true_fun.tiff"),
       width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw")
```


<br>

```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=8, fig.height=6, fig.cap="Average functional form \\beta (t)\\ with the estimated flexible parametrization"}
tbl_funcoeff %>%
  filter(SparsMethod == "weight-based" & network.model=="random" & setting =="uni" & adjust==F & epslevel.y =="none" & n==150) %>%
  rename("DGM"=dg.thresh) %>%
  rename("Noise.G"=epslevel.g) %>%
  ggplot(aes(x=fda.thresh, y=coeff.mean.ustd)) +
  geom_line() +
  scale_x_continuous("Threshold", breaks = seq(0,1,0.2)) +
  scale_y_continuous(expression("Average coefficient function "~hat(beta)(t))) +
  facet_grid(Noise.G~DGM, scales="free_y", labeller = label_both) +
  theme_bw() +
  theme(text = element_text(size=12),
                             axis.text.x = element_text(angle = 45,
                                                        vjust = 0.5,
                                                        size = 12))
ggsave(file = paste0(sim.path, "/fig_est_fun.tiff"),
       width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw")
```

<br>

```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=8, fig.height=6, fig.cap="Average functional form \\beta (t)\\ with the estimated flexible parametrization"}
tbl_funcoeff %>%
  filter(SparsMethod == "weight-based" & network.model=="random" & setting =="uni" & dg.thresh %in% c("single", "random", "half-sine") & adjust==F & epslevel.y =="none" & n==300) %>%
  rename("DGM"=dg.thresh) %>%
  rename("Noise.G"=epslevel.g) %>%
  ggplot(aes(x=fda.thresh, y=coeff.mean.ustd)) +
  geom_line() +
  scale_x_continuous("Threshold", breaks = seq(0,1,0.2)) +
  scale_y_continuous(expression("Average coefficient function "~hat(beta)(t)), lim=c(-1000,1000)) +
  facet_grid(Noise.G~DGM, scales="free_y", labeller = label_both) +
  theme_bw() +
  theme(text = element_text(size=20),
                             axis.text.x = element_text(angle = 45,
                                                        vjust = 0.5,
                                                        size = 16))
ggsave(file = paste0(sim.path, "/fig_est_fun_red.tiff"),
       width=1.75*200, height=1*200, units="mm", dpi=350, compression = "lzw")
```
<br>

```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=8, fig.height=6, fig.cap="Averaged RMSE over runs comparing the true functional form \\beta (t)\\ with the estimated flexible parametrization"}
tbl_funs %>%
  filter(SparsMethod == "weight-based" & network.model=="random" & setting =="uni" & adjust==F & epslevel.g=="none" & epslevel.y =="none" & !(dg.thresh %in% c("single", "random"))) %>%
  rename("DGM"=dg.thresh) %>%
  ggplot(aes(x=fda.thresh, y=aRMSE.ustd)) +
  geom_line() +
  scale_x_continuous("Threshold", breaks = seq(0,1,0.2)) +
  scale_y_continuous("Averaged RMSE(t) over runs") +
  facet_grid(n ~ DGM, scales="free_y", labeller = label_both) +
  theme_bw() +
  theme(text = element_text(size=16),
        axis.text.x = element_text(angle = 45,
                                   vjust = 0.5,
                                   size = 12))
```

<br>

```{r, echo=F, warning=F, message=F, fig.align='center', fig.width=8, fig.height=6, fig.cap="Averaged RMSE 10 runs comparing the true functional form \\beta (t)\\ with the standardized estimated flexible parametrization"}
tbl_funs %>%
  filter(SparsMethod == "weight-based" & network.model=="random" & setting =="uni" & adjust==F & epslevel.g=="none" & epslevel.y =="none"& !(dg.thresh %in% c("single", "random"))) %>%
  rename("DGM"=dg.thresh) %>%
  ggplot(aes(x=fda.thresh, y=aRMSE.std)) +
  geom_line() +
  scale_x_continuous("Threshold", breaks = seq(0,1,0.2)) +
  scale_y_continuous("RMSE averaged over runs") +
  facet_nested(n ~ DGM, scales="free_y", labeller = label_both) +
  theme_bw() +
  theme(text = element_text(size=16),
                             axis.text.x = element_text(angle = 45,
                                                        vjust = 0.5,
                                                        size = 12))
```